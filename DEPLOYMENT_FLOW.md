# InfraCore 部署流程图解

## 🎯 部署流程总览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    InfraCore 部署脚本 (server-deploy.sh)                │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  第 1 步：初始化                                                          │
│  • 解析命令行参数                                                         │
│  • 检查 root 权限                                                         │
│  • 检查配置文件                                                           │
│  • 显示欢迎信息                                                           │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  第 2 步：显示部署计划                                                    │
│  • 目标仓库和分支                                                         │
│  • 部署目录                                                               │
│  • 环境类型 (production/staging/development)                            │
│  • 部署类型 (Docker/Binary)                                              │
│  • 备份选项                                                               │
│  • 镜像加速选项                                                           │
│  • 等待用户确认                                                           │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  第 3 步：预部署检查 (6 项检查)                                           │
│  ✓ 配置文件完整性                                                         │
│  ✓ 端口可用性 (80, 443, 8082, 9090, 8085, 8086)                         │
│  ✓ 系统资源 (CPU, 内存, 磁盘)                                            │
│  ✓ 依赖项 (git, curl, docker 等)                                         │
│  ✓ 网络连通性                                                             │
│  ✓ 现有部署检查                                                           │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  第 4 步：安装依赖                                                        │
│  • 更新包管理器 (apt/yum/dnf)                                            │
│  • 安装基础工具 (git, curl, wget, jq)                                    │
│  • 安装 Docker (如需)                                                     │
│  • 安装 Docker Compose (如需)                                            │
│  • 配置镜像加速 (如启用)                                                  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  第 5 步：环境设置                                                        │
│  • 创建服务用户 (infracore)                                              │
│  • 创建目录结构：                                                         │
│    - /opt/infra-core (部署目录)                                          │
│    - /var/log/infra-core (日志目录)                                      │
│    - /etc/infra-core (配置目录)                                          │
│    - /var/lib/infra-core (数据目录)                                      │
│    - /opt/infra-core/backups (备份目录)                                  │
│  • 设置目录权限                                                           │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  第 6 步：创建备份 (可选)                                                 │
│  • 备份现有部署                                                           │
│  • 备份配置文件                                                           │
│  • 备份数据库                                                             │
│  • 保存备份信息                                                           │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  第 7 步：更新代码仓库                                                    │
│  • 克隆/拉取代码                                                          │
│  • 切换到指定分支                                                         │
│  • 更新子模块 (如有)                                                      │
│  • 设置脚本权限                                                           │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────┴───────────────┐
                    │                               │
                    ▼                               ▼
        ┌───────────────────────┐     ┌───────────────────────┐
        │   Docker 部署模式      │     │   Binary 部署模式      │
        └───────────────────────┘     └───────────────────────┘
                    │                               │
                    ▼                               ▼
        ┌───────────────────────┐     ┌───────────────────────┐
        │ • 登录 Registry (可选) │     │ • 安装 Go (如需)       │
        │ • 拉取镜像/本地构建    │     │ • 安装 Node.js (如需)  │
        │ • 设置环境配置         │     │ • 下载 Go 依赖         │
        │ • 停止现有容器         │     │ • 编译后端服务         │
        │ • 启动 Docker Compose  │     │ • 构建前端             │
        │ • 等待容器就绪         │     │ • 安装 systemd 服务    │
        └───────────────────────┘     │ • 启动系统服务         │
                    │                 └───────────────────────┘
                    │                               │
                    └───────────────┬───────────────┘
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  第 8 步：等待服务就绪                                                    │
│  • 等待服务启动 (最多 60 秒)                                              │
│  • 检查健康端点：http://localhost:8082/api/v1/health                     │
│  • 重试机制 (每 2 秒检查一次)                                             │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  第 9 步：健康验证 (8 项检查)                                             │
│  ✓ Docker 容器状态 / 系统服务状态                                         │
│  ✓ HTTP 端点响应                                                          │
│  ✓ 磁盘使用率                                                             │
│  ✓ 内存使用率                                                             │
│  ✓ 文件权限                                                               │
│  ✓ 日志错误检查                                                           │
│  • 计算健康分数 (需要 ≥75% 才通过)                                        │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │                               │
                健康 ✓                          不健康 ✗
                    │                               │
                    ▼                               ▼
        ┌───────────────────────┐     ┌───────────────────────┐
        │  部署成功              │     │  自动回滚              │
        │  • 清除回滚步骤        │     │  • 执行回滚操作        │
        │  • 停止资源监控        │     │  • 恢复之前状态        │
        │  • 生成部署指标        │     │  • 显示错误信息        │
        │  • 生成分析报告        │     │  • 保存失败日志        │
        │  • 创建状态仪表板      │     │  • 退出部署            │
        │  • 清理临时文件        │     └───────────────────────┘
        └───────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  第 10 步：显示最终状态                                                   │
│  • 服务状态                                                               │
│  • 访问地址                                                               │
│  • 部署信息                                                               │
│  • 性能指标                                                               │
│  • 下一步建议                                                             │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                            ┌───────────────┐
                            │  部署完成 🎉   │
                            └───────────────┘
```

## 🏗️ 服务架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           InfraCore 服务架构                              │
└─────────────────────────────────────────────────────────────────────────┘

                          ┌──────────────────┐
                          │   用户/客户端     │
                          └────────┬─────────┘
                                   │
                                   │ HTTP/HTTPS
                                   ▼
                    ┌──────────────────────────┐
                    │      Gate Service        │  Port 80/443
                    │   (HTTP/HTTPS 网关)      │
                    │  • SSL/TLS 终端          │
                    │  • 反向代理              │
                    │  • 负载均衡              │
                    └──────────┬───────────────┘
                               │
                ┌──────────────┼──────────────┐
                │              │              │
                ▼              ▼              ▼
    ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
    │   Console    │  │    Web UI    │  │     API      │
    │   Service    │  │  (Frontend)  │  │   Endpoints  │
    │              │  │              │  │              │
    │ Port 8082    │  │   React      │  │   REST API   │
    └──────┬───────┘  └──────────────┘  └──────────────┘
           │
           │ 管理后台
           │
           ▼
    ┌─────────────────────────────────────────────┐
    │            核心服务层                        │
    ├─────────────┬────────────┬──────────────────┤
    │             │            │                  │
    ▼             ▼            ▼                  ▼
┌────────┐  ┌─────────┐  ┌─────────┐  ┌──────────────┐
│ Orch   │  │  Probe  │  │  Snap   │  │    其他服务   │
│ 容器编排 │  │ 健康监控 │  │ 备份快照 │  │   (扩展)     │
│        │  │         │  │         │  │              │
│Port    │  │Port     │  │Port     │  │              │
│9090    │  │8085     │  │8086     │  │              │
└───┬────┘  └────┬────┘  └────┬────┘  └──────────────┘
    │            │            │
    └────────────┼────────────┘
                 │
                 ▼
    ┌──────────────────────────┐
    │      数据持久层           │
    │  • SQLite (Console DB)   │
    │  • Docker Volumes        │
    │  • 文件系统 (Logs, Data) │
    └──────────────────────────┘
```

## 📊 数据流向

```
┌──────────────────────────────────────────────────────────────────────────┐
│                         请求 → 响应流程                                   │
└──────────────────────────────────────────────────────────────────────────┘

客户端请求
    │
    ├─► https://example.com
    │   └─► Gate Service (Port 443)
    │       └─► SSL/TLS 解密
    │           └─► 路由到相应服务
    │
    ├─► /api/v1/*
    │   └─► Console Service (Port 8082)
    │       ├─► 认证/授权 (JWT)
    │       ├─► 业务逻辑处理
    │       ├─► 数据库操作
    │       └─► 返回 JSON 响应
    │
    ├─► /orchestrator/*
    │   └─► Orchestrator Service (Port 9090)
    │       ├─► 容器管理
    │       ├─► 服务编排
    │       └─► 资源调度
    │
    ├─► /probe/*
    │   └─► Probe Service (Port 8085)
    │       ├─► 健康检查
    │       ├─► 性能监控
    │       └─► 告警通知
    │
    └─► /snap/*
        └─► Snap Service (Port 8086)
            ├─► 备份创建
            ├─► 快照管理
            └─► 数据恢复
```

## 🔄 回滚机制

```
┌──────────────────────────────────────────────────────────────────────────┐
│                           回滚流程                                        │
└──────────────────────────────────────────────────────────────────────────┘

部署过程
    │
    ├─► 每个关键步骤都记录回滚操作
    │   • add_rollback_step("回滚命令")
    │   • 回滚步骤栈：ROLLBACK_STEPS[]
    │
    ├─► 监控部署状态
    │   • DEPLOYMENT_STARTED = true
    │   • 错误处理器监听
    │
    └─► 发生错误
        │
        ▼
    ┌────────────────────────────┐
    │   自动回滚触发              │
    │                            │
    │  • 捕获错误信息            │
    │  • 记录失败位置            │
    │  • 触发 execute_rollback() │
    └────────┬───────────────────┘
             │
             ▼
    ┌────────────────────────────┐
    │   执行回滚步骤 (逆序)       │
    │                            │
    │  for step in reverse:     │
    │    • 停止新服务            │
    │    • 恢复原配置            │
    │    • 删除新文件            │
    │    • 恢复备份              │
    └────────┬───────────────────┘
             │
             ▼
    ┌────────────────────────────┐
    │   系统恢复到原状态          │
    │                            │
    │  • 服务回到部署前状态      │
    │  • 数据完整性保持          │
    │  • 生成回滚报告            │
    └────────────────────────────┘
```

## 🎯 部署决策树

```
开始部署
    │
    ├─► 选择部署类型
    │   │
    │   ├─► Docker 部署
    │   │   │
    │   │   ├─► 有 GitHub Token?
    │   │   │   ├─► 是 → 拉取镜像
    │   │   │   └─► 否 → 本地构建
    │   │   │
    │   │   └─► docker-compose up -d
    │   │
    │   └─► Binary 部署
    │       │
    │       ├─► 检查 Go 版本
    │       │   └─► 不满足 → 安装 Go
    │       │
    │       ├─► 检查 Node.js
    │       │   └─► 不存在 → 安装 Node.js
    │       │
    │       ├─► 编译服务
    │       │   ├─► console
    │       │   ├─► gate
    │       │   ├─► orchestrator
    │       │   ├─► probe
    │       │   └─► snap
    │       │
    │       ├─► 构建前端
    │       │   └─► npm ci && npm run build
    │       │
    │       └─► 启动服务
    │           ├─► systemd 可用?
    │           │   ├─► 是 → 使用 systemctl
    │           │   └─► 否 → 使用启动脚本
    │           └─► 设置开机自启
    │
    └─► 继续健康检查
```

## 📦 目录结构

```
/opt/infra-core/                    # 主部署目录
├── current/                        # 当前部署版本
│   ├── cmd/                        # 服务入口
│   │   ├── console/
│   │   ├── gate/
│   │   ├── orch/
│   │   ├── probe/
│   │   └── snap/
│   ├── pkg/                        # 共享包
│   ├── ui/                         # 前端代码
│   ├── configs/                    # 配置文件
│   │   ├── production.yaml
│   │   ├── development.yaml
│   │   └── testing.yaml
│   ├── scripts/                    # 辅助脚本
│   ├── docker-compose.yml
│   └── Dockerfile
├── backups/                        # 备份目录
│   ├── backup-20251007-150000/
│   └── backup-20251006-120000/
└── logs/                          # 部署日志
    └── deployment-xxx.log

/var/log/infra-core/               # 服务日志
├── gate.log
├── console.log
├── orchestrator.log
├── probe.log
└── snap.log

/etc/infra-core/                   # 系统配置
└── certs/                         # SSL 证书

/var/lib/infra-core/               # 数据目录
├── console.db                     # Console 数据库
└── snapshots/                     # 快照数据
```

## 🚀 快速参考

### 基础部署命令

```bash
# Docker 部署（推荐）
sudo ./server-deploy.sh --docker --backup

# 二进制部署
sudo ./server-deploy.sh --binary --backup

# 使用镜像加速
sudo ./server-deploy.sh --docker --mirror cn --backup

# 非交互模式
NON_INTERACTIVE=true sudo ./server-deploy.sh --docker
```

### 管理命令

```bash
# 查看状态
sudo ./server-deploy.sh --status

# 查看日志
sudo ./server-deploy.sh --logs

# 重启服务
sudo ./server-deploy.sh --restart

# 停止服务
sudo ./server-deploy.sh --stop

# 启动服务
sudo ./server-deploy.sh --start

# 回滚
sudo ./server-deploy.sh --rollback

# 快速更新
sudo ./server-deploy.sh --update

# 配置管理
sudo ./server-deploy.sh --configure
```

### 健康检查

```bash
# 手动检查 Console API
curl http://localhost:8082/api/v1/health

# 检查所有服务
sudo ./server-deploy.sh --status

# 查看 Docker 容器
docker-compose -f /opt/infra-core/current/docker-compose.yml ps

# 查看系统服务
systemctl status infra-core-*
```

### 故障排查

```bash
# 查看部署日志
cat /var/log/infra-core/deploy.log

# 查看服务日志
tail -f /var/log/infra-core/*.log

# 运行诊断
sudo ./server-deploy.sh --troubleshoot

# 测试 API
sudo ./server-deploy.sh --test-api

# 验证安装
sudo ./server-deploy.sh --test-install
```

## 📈 性能和资源

### 最低系统要求

- **CPU**: 2 核心
- **内存**: 4 GB RAM
- **磁盘**: 20 GB 可用空间
- **网络**: 稳定的互联网连接

### 推荐系统配置

- **CPU**: 4+ 核心
- **内存**: 8+ GB RAM
- **磁盘**: 50+ GB SSD
- **网络**: 100+ Mbps

### 服务端口

| 服务 | 端口 | 用途 |
|------|------|------|
| Gate | 80 | HTTP |
| Gate | 443 | HTTPS |
| Console | 8082 | 管理 API |
| Orchestrator | 9090 | 容器编排 |
| Probe | 8085 | 健康监控 |
| Snap | 8086 | 备份服务 |

---

**提示**: 保存此文件以便快速参考部署流程和命令！
